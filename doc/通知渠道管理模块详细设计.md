# 通知渠道管理模块（重新设计）

## 名称
通知渠道管理

## 功能
- 集中管理各种消息发送渠道
- 支持多种渠道类型的灵活配置
- 提供渠道测试和监控功能
- 实现渠道优先级和失败转移策略

## 核心字段

### 基础信息
- 渠道ID：唯一标识符
- 渠道名称：如"企业邮箱"、"阿里云短信"等
- 渠道类型：email/sms/wechat/dingtalk/webhook/push等
- 状态：启用/禁用/维护中
- 优先级：数字，越小优先级越高
- 创建时间：创建时间
- 更新时间：最后更新时间
- 描述：渠道用途和说明

### 通用配置
- 重试策略：
  - 最大重试次数
  - 重试间隔（秒）
  - 退避策略（固定间隔/指数退避）
- 限流设置：
  - 每秒最大请求数
  - 突发流量容量
  - 超限处理策略
- 可用时间：
  - 工作日设置
  - 时间段设置
- 渠道供应商：如阿里云、腾讯云、自建等
- 标签：用于分类和筛选

### 渠道特定配置（JSON格式）
```json
// 邮件渠道示例
{
  "smtp_server": "smtp.company.com",
  "port": 587,
  "username": "notify@company.com",
  "password": "encrypted_password",
  "use_ssl": true,
  "from_email": "notify@company.com",
  "from_name": "系统通知",
  "reply_to": "support@company.com",
  "signature": "<p>此致<br/>公司团队</p>",
  "attachment_limit": 10485760
}

// 短信渠道示例
{
  "provider": "aliyun",
  "access_key_id": "LTAI4G*****",
  "access_key_secret": "encrypted_secret",
  "sign_name": "公司名称",
  "region": "cn-hangzhou",
  "endpoint": "dysmsapi.aliyuncs.com",
  "template_mapping": {
    "verification": "SMS_123456",
    "notification": "SMS_654321"
  }
}

// 微信公众号示例
{
  "app_id": "wx1234567890",
  "app_secret": "encrypted_secret",
  "token": "custom_token",
  "encoding_aes_key": "encoded_key",
  "template_mapping": {
    "notification": "ABC123",
    "reminder": "DEF456"
  }
}

// 钉钉机器人示例
{
  "webhook_url": "https://oapi.dingtalk.com/robot/send?access_token=xxx",
  "secret": "encrypted_secret",
  "at_all_for_important": true
}
```

### 参数映射
```json
{
  "standard_params": {
    "recipient": {
      "email": "to_email",
      "sms": "phone_number",
      "wechat": "open_id",
      "dingtalk": "user_id"
    },
    "subject": {
      "email": "subject",
      "sms": null,
      "wechat": "first_data",
      "dingtalk": "title"
    },
    "content": {
      "email": "html_body",
      "sms": "content",
      "wechat": "remark",
      "dingtalk": "text"
    }
  }
}
```

### 监控指标
- 可用性：渠道当前可用状态
- 成功率：最近发送成功百分比
- 平均耗时：消息发送平均耗时
- 失败原因统计：主要失败原因分布
- 最后检测时间：上次状态检查时间

## 交互逻辑

1. **渠道配置流程**：
   - 管理员选择渠道类型
   - 系统动态加载该类型所需的配置表单
   - 填写渠道基本信息和特定配置
   - 系统加密敏感信息并保存配置
   - 提供测试功能验证配置正确性

2. **渠道测试流程**：
   - 选择需要测试的渠道
   - 填写测试接收者信息
   - 系统发送测试消息
   - 显示发送结果和详细日志
   - 提供问题诊断建议

3. **渠道选择逻辑**：
   - 根据消息类型获取可用渠道列表
   - 按优先级排序可用渠道
   - 检查渠道当前状态和限流情况
   - 选择最优渠道进行发送
   - 记录选择过程和原因

4. **失败处理机制**：
   - 检测到渠道发送失败
   - 根据重试策略安排重试
   - 达到最大重试次数后切换备用渠道
   - 所有渠道均失败时触发告警
   - 记录完整失败链路和原因

5. **渠道健康检查**：
   - 定期发送探测消息检查渠道状态
   - 监控发送成功率和响应时间
   - 当指标异常时自动调整渠道状态
   - 生成渠道健康报告
   - 异常情况触发告警通知

6. **渠道管理操作**：
   - 创建新渠道
   - 编辑现有渠道配置
   - 启用/禁用渠道
   - 调整渠道优先级
   - 查看渠道使用统计和性能指标

## 数据结构示例

```json
{
  "channel_id": "CH001",
  "channel_name": "企业邮箱",
  "channel_type": "email",
  "description": "用于发送重要通知和日常报告",
  "status": "enabled",
  "priority": 1,
  "retry_strategy": {
    "max_retries": 3,
    "retry_interval": 300,
    "backoff_policy": "exponential"
  },
  "rate_limit": {
    "requests_per_second": 100,
    "burst_capacity": 200,
    "overflow_policy": "queue"
  },
  "availability": {
    "workdays": [1, 2, 3, 4, 5],
    "work_hours": ["08:00-20:00"]
  },
  "provider": "自建系统",
  "tags": ["重要", "内部"],
  "channel_config": {
    "smtp_server": "smtp.company.com",
    "port": 587,
    "username": "notify@company.com",
    "password": "encrypted_password",
    "use_ssl": true,
    "from_email": "notify@company.com",
    "from_name": "系统通知",
    "reply_to": "support@company.com",
    "signature": "<p>此致<br/>公司团队</p>",
    "attachment_limit": 10485760
  },
  "param_mapping": {
    "recipient": "to_email",
    "subject": "subject",
    "content": "html_body",
    "attachment": "attachments"
  },
  "monitoring": {
    "availability": "available",
    "success_rate": 99.8,
    "average_latency": 1.2,
    "failure_reasons": {
      "recipient_not_found": 45,
      "server_timeout": 12,
      "authentication_failure": 2
    },
    "last_check_time": "2023-10-15T08:30:00Z"
  },
  "created_time": "2023-01-01T10:00:00Z",
  "updated_time": "2023-10-10T14:30:00Z",
  "created_by": "admin",
  "updated_by": "system"
}
```

## 渠道适配器架构

系统采用适配器模式实现各类渠道的统一接口：

```
IChannelAdapter (接口)
  ├── 发送消息(sendMessage)
  ├── 检查状态(checkStatus)
  ├── 验证配置(validateConfig)
  └── 获取渠道能力(getCapabilities)

EmailChannelAdapter
  ├── SMTP实现
  └── API实现(SendGrid, Mailgun等)

SMSChannelAdapter
  ├── 阿里云实现
  ├── 腾讯云实现
  └── 第三方服务商实现

WeChatChannelAdapter
  ├── 公众号实现
  └── 企业微信实现

DingTalkChannelAdapter

WebhookChannelAdapter

PushNotificationAdapter
  ├── iOS实现
  └── Android实现
```

这种设计使通知渠道管理模块具有高度的灵活性和可扩展性，能够适应各种不同渠道的配置需求，同时保持统一的管理界面和使用方式。新增渠道类型时，只需添加相应的配置模板和适配器实现，无需修改核心架构。



======================================================
### 参数映射：标准参数到渠道特定参数的映射关系

参数映射是通知渠道管理模块中的核心机制，用于解决不同渠道接口参数不一致的问题。详细解释如下：

**1. 概念与作用**
- **统一接口**：创建一套标准化的参数集，作为系统内部使用的通用接口
- **自动转换**：将标准参数自动转换为各渠道API所需的特定参数
- **屏蔽差异**：使业务层无需关心各渠道的具体参数要求，只需使用统一参数

**2. 映射内容示例**

标准参数 | 邮件渠道参数 | 短信渠道参数 | 微信渠道参数 | 钉钉渠道参数
-------|------------|-----------|------------|------------
recipient | to_email | phone_number | open_id | user_id
subject | subject | (不适用) | first_data | title
content | html_body | content | remark | text
attachment | attachments | (不适用) | media_id | file_url

**3. 实现方式**
- 在渠道配置中存储JSON格式的映射规则
- 映射规则定义标准参数名与渠道特定参数名的对应关系
- 系统发送消息时，根据映射规则自动转换参数

**4. 映射规则示例**
```json
{
  "recipient": "to_email",
  "cc": "cc_email",
  "bcc": "bcc_email",
  "subject": "subject",
  "content": "html_body",
  "plain_content": "text_body",
  "attachment": "attachments",
  "priority": "importance"
}
```

**5. 处理特殊情况**
- **不适用参数**：某些渠道不支持的参数映射为null
- **参数组合**：一个标准参数可能映射到多个渠道参数
- **参数拆分**：一个标准参数可能需要拆分到多个渠道参数
- **默认值**：为缺失的必要参数提供默认值
- **格式转换**：处理数据类型和格式的差异（如日期格式）

**6. 实际应用场景**

**场景一：发送通知消息**
- 标准参数：
  ```json
  {
    "recipient": "user123",
    "subject": "系统告警",
    "content": "服务器CPU使用率超过90%",
    "importance": "high"
  }
  ```

- 邮件渠道转换后：
  ```json
  {
    "to_email": "user@example.com", // 通过用户ID查询得到邮箱
    "subject": "系统告警",
    "html_body": "服务器CPU使用率超过90%",
    "importance": "high"
  }
  ```

- 短信渠道转换后：
  ```json
  {
    "phone_number": "13800138000", // 通过用户ID查询得到手机号
    "content": "系统告警: 服务器CPU使用率超过90%", // 自动合并主题和内容
    "priority": 1 // 高优先级映射为数字1
  }
  ```

**7. 映射的优势**
- **降低耦合**：业务逻辑与具体渠道实现解耦
- **简化集成**：新增渠道只需配置映射规则，无需修改业务代码
- **统一管理**：集中管理所有渠道的参数映射
- **灵活配置**：可以根据需求动态调整映射关系
- **版本兼容**：当渠道API变更时，只需更新映射规则

**8. 高级映射功能**
- **转换函数**：支持参数值的格式转换和处理
- **条件映射**：根据条件选择不同的映射规则
- **级联映射**：支持多级参数结构的映射
- **模板替换**：支持在参数值中使用模板语法
- **动态查询**：支持从其他数据源动态获取映射值

通过这种参数映射机制，消息中心系统能够以统一的方式处理不同渠道的消息发送，大大简化了开发和维护工作，同时提高了系统的灵活性和可扩展性。