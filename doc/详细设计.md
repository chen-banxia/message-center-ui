# 企业级消息中心系统详细设计

## 一、系统概述

消息中心系统是一个集中管理和分发各类消息通知的平台，支持多系统对接、多模板管理、多接收者配置、多通知渠道和多消息类型。

## 二、功能模块设计

### 1. 系统对接管理模块

**名称**：系统对接管理

**功能**：
- 管理接入消息中心的外部系统
- 提供API接口供外部系统调用
- 管理系统权限和鉴权信息

**核心字段**：
- 系统ID：唯一标识符
- 系统名称：对接系统名称
- 系统描述：系统简介
- 接入密钥：API调用认证密钥
- 回调URL：消息发送结果回调地址
- 状态：启用/禁用
- 创建时间：系统接入时间
- 更新时间：最后更新时间
- IP白名单：允许访问的IP列表

**交互逻辑**：
1. 系统管理员创建新的对接系统记录
2. 生成唯一的接入密钥
3. 外部系统使用密钥调用消息中心API
4. 系统可以查看、编辑和删除对接系统信息

### 2. 消息模板管理模块

**名称**：消息模板管理

**功能**：
- 创建和管理消息模板
- 支持多变量占位符设置
- 支持多通知渠道的模板内容
- 模板版本控制和审核
- 模板场景管理和分类
- 模板变量验证和默认值设置

**核心字段**：
- 模板ID：唯一标识符
- 模板名称：模板名称
- 模板编码：业务编码
- 模板类型：对应消息类型
- 适用渠道：支持的通知渠道列表
- 模板内容：各渠道的具体内容（支持HTML、纯文本等）
- 场景说明：模板适用的业务场景描述
- 使用示例：模板使用示例和效果展示
- 变量列表：支持的变量配置（JSON格式）：
  ```json
  [
    {
      "name": "userName",      // 变量名
      "dataType": "string",    // 数据类型：string/number/boolean/date/array/object
      "required": true,        // 是否必填
      "description": "用户姓名", // 变量说明
      "validationRule": "",    // 验证规则（正则表达式或规则描述）
      "maxLength": 50,         // 最大长度（适用于string类型）
      "example": "张三"         // 示例值
    }
  ]
  ```
- 状态：草稿/审核中/已发布/已禁用
- 创建人：创建者ID
- 创建时间：创建时间
- 更新时间：最后更新时间
- 版本号：当前版本
- 历史版本：历史版本记录
- 审核信息：审核人、审核时间、审核意见
- 使用频率：模板使用次数统计
- 有效期：模板有效期设置

**交互逻辑**：
1. 模板管理员创建模板，设置各渠道内容和变量
2. 配置变量属性，包括数据类型、是否必填、默认值等
3. 添加场景说明和使用示例，便于其他开发者理解
4. 提交模板审核
5. 审核通过后发布模板
6. 外部系统调用时引用模板ID并传入变量值
7. 系统自动验证变量格式和必填项
8. 支持模板预览功能，可测试变量替换效果
9. 模板更新时保留历史版本，支持版本回滚
10. 提供模板使用统计和分析

**场景示例**：
1. **订单确认通知**
   - 场景说明：用户下单后发送订单确认信息
   - 变量列表：订单号、订单金额、下单时间、预计发货时间
   - 适用渠道：短信、邮件、站内信、微信

2. **支付成功通知**
   - 场景说明：用户完成支付后的通知
   - 变量列表：订单号、支付金额、支付时间、支付方式
   - 适用渠道：短信、站内信、微信

3. **账户异常登录提醒**
   - 场景说明：检测到异常IP或设备登录时的安全提醒
   - 变量列表：登录时间、登录IP、登录设备、登录地点
   - 适用渠道：短信、邮件、站内信

**变量类型示例**：
```json
[
  {
    "name": "orderNo",
    "dataType": "string",
    "required": true,
    "description": "订单号",
    "validationRule": "^[A-Z0-9]{8,15}$",
    "example": "ORD20230615001"
  },
  {
    "name": "amount",
    "dataType": "number",
    "required": true,
    "description": "金额",
    "format": "0,0.00",
    "example": 199.99
  },
  {
    "name": "orderTime",
    "dataType": "date",
    "required": true,
    "description": "下单时间",
    "format": "yyyy-MM-dd HH:mm:ss",
    "example": "2023-06-15 14:30:25"
  },
  {
    "name": "productList",
    "dataType": "array",
    "required": false,
    "description": "商品列表",
    "example": [{"name": "商品1", "price": 99.5, "quantity": 2}]
  },
  {
    "name": "isVIP",
    "dataType": "boolean",
    "required": false,
    "description": "是否VIP用户",
    "defaultValue": false,
    "example": true
  }
]
```

### 3. 接收者管理模块

**名称**：接收者管理

**功能**：
- 管理消息接收者信息
- 支持个人和群组两种接收者类型
- 管理接收者的联系方式
- 支持接收者订阅和屏蔽设置

**核心字段**：
- 接收者ID：唯一标识符
- 接收者类型：个人/群组
- 接收者名称：姓名或群组名称
- 联系信息：
  - 邮箱地址
  - 手机号码
  - 用户ID（站内信）
  - 微信OpenID
  - 钉钉ID等
- 状态：启用/禁用
- 创建时间：创建时间
- 更新时间：最后更新时间
- 订阅设置：订阅的消息类型列表
- 屏蔽设置：屏蔽的消息类型列表
- 所属部门：部门ID（个人）
- 群组成员：成员ID列表（群组）

**交互逻辑**：
1. 管理员创建和管理接收者信息
2. 接收者可以自行设置订阅和屏蔽规则
3. 群组管理员可以管理群组成员
4. 支持从企业通讯录同步接收者信息

### 4. 通知渠道管理模块

**名称**：通知渠道管理

**功能**：
- 管理各种消息发送渠道
- 配置渠道参数和发送规则
- 监控渠道状态和发送情况
- 支持渠道优先级和失败转移
- 提供渠道测试和健康检查功能

**核心字段**：
- 渠道ID：唯一标识符
- 渠道名称：如站内信、邮件、短信等
- 渠道类型：email/sms/wechat/dingtalk/webhook等
- 渠道配置（JSON格式）：
  - 邮件特有配置（smtp服务器、端口、账号等）
  - 短信特有配置（供应商API密钥、签名等）
  - 微信特有配置（AppID、AppSecret等）
  - 钉钉特有配置（Webhook地址、加签密钥等）
- 参数映射：标准参数到渠道特定参数的映射关系
# 参数映射说明：
# 系统定义一套标准参数（如收件人、主题、内容等），通过映射关系转换为各渠道所需的特定参数

# 邮件渠道映射示例：
{
  "recipient": "to_email",      # 收件人 → 邮箱地址
  "subject": "subject",         # 主题 → 邮件主题
  "content": "html_body",       # 内容 → HTML正文
  "attachment": "attachments"   # 附件 → 附件列表
}

# 短信渠道映射示例：
{
  "recipient": "phone_number",  # 收件人 → 手机号码
  "content": "content",         # 内容 → 短信内容
  "template_id": "template_code" # 模板ID → 短信模板编码
}

# 微信渠道映射示例：
{
  "recipient": "open_id",       # 收件人 → 微信OpenID
  "subject": "first_data",      # 主题 → 模板首行数据
  "content": "remark",          # 内容 → 模板备注
  "url": "url"                  # 链接 → 点击跳转URL
}

- 状态：启用/禁用/维护中
- 优先级：数字，越小优先级越高
- 重试策略：重试次数、间隔时间、退避策略
- 限流设置：每秒最大请求数、突发容量
- 可用时间：工作日和时间段设置
- 监控指标：可用性、成功率、平均耗时等
- 创建时间：创建时间
- 更新时间：最后更新时间
- 渠道供应商：如阿里云、腾讯云、自建等
- 标签：用于分类和筛选

**交互逻辑**：
1. 系统管理员选择渠道类型，系统动态加载配置表单
2. 填写渠道基本信息和特定配置，系统加密敏感信息
3. 提供测试功能验证配置正确性
4. 系统根据消息类型和优先级选择最优可用渠道
5. 监控渠道发送状态，失败时按重试策略处理
6. 达到最大重试次数后自动切换备用渠道
7. 定期执行健康检查，异常时调整渠道状态
8. 生成渠道性能和使用统计报告

**参数映射应用示例**：
当业务系统发送一条标准消息：
```json
{
  "recipient": "user123",
  "subject": "订单确认通知",
  "content": "您的订单#98765已确认，预计3天内发货。",
  "importance": "normal"
}
```

通过参数映射，系统会自动转换为各渠道所需的格式：

1. 邮件渠道：
```json
{
  "to_email": "user@example.com",  // 通过user123查询到的邮箱
  "subject": "订单确认通知",
  "html_body": "您的订单#98765已确认，预计3天内发货。",
  "importance": "normal"
}
```

2. 短信渠道：
```json
{
  "phone_number": "13800138000",  // 通过user123查询到的手机号
  "content": "【公司名】订单确认通知：您的订单#98765已确认，预计3天内发货。",
  "template_code": "SMS_10086",
  "template_param": {"order_id": "98765", "days": "3"}
}
```

3. 微信公众号：
```json
{
  "open_id": "oABC123DEF456",  // 通过user123查询到的微信OpenID
  "template_id": "wxt_order_confirm",
  "data": {
    "first": {"value": "订单确认通知", "color": "#173177"},
    "keyword1": {"value": "#98765", "color": "#173177"},
    "keyword2": {"value": "已确认", "color": "#173177"},
    "remark": {"value": "预计3天内发货。", "color": "#173177"}
  },
  "url": "https://example.com/orders/98765"
}
```

通过这种参数映射机制，业务系统只需使用统一的标准参数发送消息，系统会根据配置的映射规则自动转换为各渠道所需的特定格式，大大简化了多渠道消息发送的复杂性。


### 5. 消息类型管理模块

**名称**：消息类型管理

**功能**：
- 管理不同类型的消息
- 设置类型的处理策略和优先级
- 配置类型的默认模板和渠道

**核心字段**：
- 类型ID：唯一标识符
- 类型名称：如系统通知、告警、运营等
- 类型描述：类型说明
- 优先级：数字，越小优先级越高
- 默认渠道：默认使用的通知渠道列表
- 默认模板：默认使用的模板ID
- 状态：启用/禁用
- 创建时间：创建时间
- 更新时间：最后更新时间
- 图标：类型图标
- 颜色：类型标识颜色

**交互逻辑**：
1. 系统管理员创建和管理消息类型
2. 外部系统发送消息时指定消息类型
3. 系统根据类型选择默认渠道和模板
4. 接收者可以针对不同类型设置订阅规则

### 6. 消息发送管理模块

**名称**：消息发送管理

**功能**：
- 接收外部系统的消息请求
- 根据模板和变量生成消息内容
- 选择合适的渠道发送消息
- 记录发送状态和历史

**核心字段**：
- 消息ID：唯一标识符
- 来源系统：发送消息的系统ID
- 消息类型：消息类型ID
- 模板ID：使用的模板ID
- 变量数据：JSON格式的变量数据
- 接收者列表：接收者ID列表
- 发送渠道：使用的渠道ID
- 发送状态：待发送/发送中/发送成功/发送失败
- 创建时间：创建时间
- 发送时间：实际发送时间
- 重试次数：当前重试次数
- 失败原因：发送失败的原因
- 消息内容：最终生成的消息内容
- 优先级：发送优先级
- 定时发送：是否定时发送及时间

**交互逻辑**：
1. 外部系统调用API发送消息请求
2. 系统验证请求参数和权限
3. 根据模板和变量生成消息内容
4. 选择合适的渠道发送给指定接收者
5. 记录发送状态和结果
6. 支持定时发送和批量发送

### 7. 消息中心前端模块

**名称**：消息中心前端

**功能**：
- 提供站内信消息展示界面
- 支持消息查看、标记和管理
- 提供消息订阅和设置界面
- 支持消息实时推送

**核心字段**：
- 消息ID：唯一标识符
- 消息标题：消息标题
- 消息内容：消息正文
- 消息类型：消息类型ID
- 发送时间：发送时间
- 阅读状态：未读/已读
- 重要标记：是否标记为重要
- 操作按钮：消息相关操作
- 跳转链接：点击消息后的跳转地址

**交互逻辑**：
1. 用户登录系统后查看个人消息中心
2. 显示未读消息数量和列表
3. 用户可以查看、标记和删除消息
4. 支持消息筛选、搜索和分类查看
5. 提供消息订阅设置界面
6. 支持WebSocket实时推送新消息

### 8. 统计分析模块

**名称**：统计分析

**功能**：
- 统计消息发送数量和状态
- 分析各渠道发送成功率
- 监控系统性能和负载
- 生成报表和可视化图表

**核心字段**：
- 时间维度：日/周/月/年
- 系统维度：按来源系统统计
- 类型维度：按消息类型统计
- 渠道维度：按发送渠道统计
- 发送量：消息发送总量
- 成功率：发送成功百分比
- 失败原因：主要失败原因分布
- 平均耗时：消息发送平均耗时
- 高峰期：消息发送高峰时段
- 接收者活跃度：接收者查看消息情况

**交互逻辑**：
1. 管理员查看统计报表
2. 支持多维度数据筛选和查询
3. 提供数据导出功能
4. 支持自定义报表和仪表盘
5. 异常数据自动预警

### 9. 系统配置管理模块

**名称**：系统配置管理

**功能**：
- 管理系统全局配置
- 设置系统参数和策略
- 管理系统角色和权限
- 配置系统日志和审计

**核心字段**：
- 配置项：配置项名称
- 配置值：配置项值
- 配置描述：配置项说明
- 配置类型：全局/模块
- 是否可修改：是/否
- 创建时间：创建时间
- 更新时间：最后更新时间
- 操作人：最后操作人
- 角色列表：系统角色定义
- 权限项：权限项定义
- 日志级别：系统日志级别设置

**交互逻辑**：
1. 系统管理员管理全局配置
2. 设置系统角色和权限
3. 配置系统运行参数
4. 查看系统日志和审计记录

### 10. 消息归档和清理模块

**名称**：消息归档清理

**功能**：
- 定期归档历史消息
- 清理过期消息数据
- 管理数据存储策略
- 支持消息备份和恢复

**核心字段**：
- 归档策略：归档规则设置
- 归档周期：归档执行周期
- 保留时间：数据保留时长
- 清理策略：数据清理规则
- 备份设置：是否备份及方式
- 存储位置：归档数据存储位置
- 执行时间：上次执行时间
- 执行状态：成功/失败
- 影响记录：处理记录数量

**交互逻辑**：
1. 系统管理员设置归档和清理策略
2. 系统定期执行归档任务
3. 清理过期数据释放存储空间
4. 支持手动触发归档和恢复

## 三、数据流程

1. **消息发送流程**：
   - 外部系统调用API发送消息请求
   - 系统验证请求合法性
   - 根据模板和变量生成消息内容
   - 确定接收者列表和发送渠道
   - 发送消息并记录状态
   - 返回发送结果给外部系统

2. **消息接收流程**：
   - 用户登录系统查看消息中心
   - 系统加载用户未读消息
   - 用户查看消息详情
   - 系统更新消息状态为已读
   - 用户可进行标记、删除等操作

3. **模板管理流程**：
   - 模板管理员创建模板
   - 设置模板内容和变量
   - 提交审核
   - 审核通过后发布
   - 外部系统可使用已发布模板

4. **系统对接流程**：
   - 系统管理员创建对接系统记录
   - 生成接入密钥
   - 配置系统参数和权限
   - 外部系统使用密钥调用API

## 四、系统架构

1. **前端层**：
   - Vue 3 + Element Plus构建的管理界面
   - 消息中心用户界面
   - WebSocket实时推送模块

2. **接口层**：
   - RESTful API接口
   - 鉴权和安全控制
   - 接口限流和保护

3. **业务层**：
   - 消息处理核心服务
   - 模板引擎
   - 发送策略管理
   - 任务调度服务

4. **存储层**：
   - 关系型数据库（消息元数据）
   - NoSQL数据库（消息内容）
   - 缓存服务（高频数据）
   - 文件存储（附件和归档）

5. **基础设施**：
   - 消息队列（异步处理）
   - 日志系统
   - 监控告警
   - 负载均衡

这个设计提供了一个全面的企业级消息中心系统框架，涵盖了多系统对接、多模板管理、多接收者配置、多通知渠道和多消息类型的需求，同时增加了统计分析、系统配置和数据归档等功能模块，确保系统的完整性和可扩展性。